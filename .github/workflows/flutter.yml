name: Test, Build & Release

on:
  push:
    branches: [ main ]

jobs:
    release:
      name: Test, Build & Release

      runs-on: ubuntu-latest

      steps:
        - name: Checkout
          uses: actions/checkout@v1

        - name: Setup Java
          uses: actions/setup-java@v1
          with:
            java-version: '12.x'

        - name: Setup Flutter
          uses: subosito/flutter-action@v1
          with:
            channel: stable

        - name: Cache pub dependencies
          uses: actions/cache@v2
          with:
            path: ${{ env.FLUTTER_HOME }}/.pub-cache
            key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
            restore-keys: ${{ runner.os }}-pub-

        - name: Download pub dependencies
          run: flutter pub get
          
        - name: Run Unit Testing
          run: flutter test test/uri_to_file_test.dart
          
        - name: Create credentials.json
          run: |
            cd ${{ env.PUB_CACHE }}
            echo "${{ secrets.FLUTTER_PUBLISH_CREDENTIALS }}" > credentials.json
            
        - name: Publish Package
          run: flutter pub publish --dry-run
